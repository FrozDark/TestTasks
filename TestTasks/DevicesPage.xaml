<Page
    x:Class="TestTasks.DevicesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:TestTasks"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="clr-namespace:TestModels;assembly=TestModels"
    xmlns:templates="clr-namespace:TestTasks.DataTemplates"
    xmlns:vm="clr-namespace:TestViewModels;assembly=TestViewModels"
    xmlns:vmd="clr-namespace:TestViewModels.Dialogs;assembly=TestViewModels"
    Title="Страница устройств"
    d:DesignHeight="450"
    d:DesignWidth="800"
    mc:Ignorable="d">

    <d:DesignData.DataContext>
        <vm:DevicesViewModel />
    </d:DesignData.DataContext>

    <Page.InputBindings>
        <KeyBinding
            Key="Delete"
            Command="{Binding DeleteDeviceCommand, Mode=OneTime}"
            CommandParameter="{Binding SelectedDevice}" />
    </Page.InputBindings>

    <Page.Resources>
        <!--  Для более продвинутого шаблонирования, хотя и примитивно тут, только демонстрация возможностей  -->
        <templates:DevicesHeaderTemplates x:Key="headerTemplates">
            <templates:DevicesHeaderTemplates.DefaultTemplate>
                <DataTemplate DataType="{x:Type models:BaseDevice}">
                    <TextBlock
                        FontSize="14"
                        FontWeight="Bold"
                        Text="❔Неизвестное утройство" />
                </DataTemplate>
            </templates:DevicesHeaderTemplates.DefaultTemplate>

            <templates:DevicesHeaderTemplates.KeyboardTemplate>
                <DataTemplate DataType="{x:Type models:Keyboard}">
                    <TextBlock
                        FontSize="14"
                        FontWeight="Bold"
                        Text="⌨️ Клавиатуры" />
                </DataTemplate>
            </templates:DevicesHeaderTemplates.KeyboardTemplate>

            <templates:DevicesHeaderTemplates.MouseTemplate>
                <DataTemplate DataType="{x:Type models:Mouse}">
                    <TextBlock
                        FontSize="14"
                        FontWeight="Bold"
                        Text="🖱️ Мыши" />
                </DataTemplate>
            </templates:DevicesHeaderTemplates.MouseTemplate>

            <templates:DevicesHeaderTemplates.PrinterTemplate>
                <DataTemplate DataType="{x:Type models:Printer}">
                    <TextBlock
                        FontSize="14"
                        FontWeight="Bold"
                        Text="🖨️ Принтеры" />
                </DataTemplate>
            </templates:DevicesHeaderTemplates.PrinterTemplate>

            <templates:DevicesHeaderTemplates.InputDeviceTemplate>
                <DataTemplate DataType="{x:Type models:InputDevice}">
                    <TextBlock
                        FontSize="14"
                        FontWeight="Bold"
                        Text="🎙 Устройства ввода" />
                </DataTemplate>
            </templates:DevicesHeaderTemplates.InputDeviceTemplate>

            <!--  Монитор должен попасть в категорию Устройства вывода, т.к. незадекларирован его шаблон, поэтому используется обобщённый  -->
            <templates:DevicesHeaderTemplates.OutputDeviceTemplate>
                <DataTemplate DataType="{x:Type models:OutputDevice}">
                    <TextBlock
                        FontSize="14"
                        FontWeight="Bold"
                        Text="📺 Устройства вывода" />
                </DataTemplate>
            </templates:DevicesHeaderTemplates.OutputDeviceTemplate>
        </templates:DevicesHeaderTemplates>

        <!--
            К сожалению, имея TestViewModels как отдельный проект, с максимальным разделением от UI
            не имеющий связей с нашим UI и ссылок на Presenation Framework, без code-behind сделать фильтр - невозможно
            Поэтому фильтровать (поиск) коллекцию будем в самом ViewModel
        -->
        <CollectionViewSource x:Key="cvs" Source="{Binding Items}">
            <CollectionViewSource.GroupDescriptions>
                <PropertyGroupDescription Converter="{StaticResource GroupByTypeConverter}" />
            </CollectionViewSource.GroupDescriptions>
        </CollectionViewSource>
    </Page.Resources>

    <Grid>
        <!--
            Можно было бы разделить на 2 окна тут использовав ещё по Grid на каждый столбец.
            Левое окно Grid со списком и правое Grid со свойствами.
            Но чем меньше вложенных эелементов, тем оптимальнее будет по затратами ресурсов компьютера
            Поэтому один корневой Grid будет управлять расположением эелементов, тем более что дизайн не очень сложный
        -->
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="0.4*" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition />
        </Grid.ColumnDefinitions>

        <Grid.RowDefinitions>
            <RowDefinition Height="20" />
            <RowDefinition Height="25" />
            <RowDefinition />
            <RowDefinition Height="30" />
        </Grid.RowDefinitions>

        <GridSplitter
            Grid.RowSpan="3"
            Grid.Column="1"
            Width="3"
            HorizontalAlignment="Center"
            VerticalAlignment="Stretch"
            ShowsPreview="False" />

        <Grid>
            <TextBox
                x:Name="txtSearchBox"
                Margin="1"
                Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <!--  Стандартный контрол TextBox не имеет placeholder, сделал через контрол, лень было рестайлить =(  -->
            <TextBlock
                Margin="10,0,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Center"
                Foreground="DarkGray"
                IsHitTestVisible="False"
                Text="Поиск...">
                <TextBlock.Style>
                    <Style TargetType="{x:Type TextBlock}">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Text, ElementName=txtSearchBox}" Value="">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>
        </Grid>

        <ComboBox
            Grid.Row="1"
            DisplayMemberPath="Display"
            ItemsSource="{Binding Statuses, Mode=OneTime}"
            SelectedValue="{Binding SearchStatus, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
            SelectedValuePath="Status" />
        <!--  Для оптимизации используем ItemsSource OneTime, т.к. данные статичные  -->

        <ListBox
            Grid.Row="2"
            ItemsSource="{Binding Source={StaticResource cvs}}"
            ScrollViewer.HorizontalScrollBarVisibility="Disabled"
            SelectedItem="{Binding SelectedDevice, Mode=TwoWay}"
            SelectionMode="Single">
            <!--  Отключив горизонтальный скролл, мы позволив тексту с описанием Name делать перенос строк  -->
            <ListBox.GroupStyle>
                <GroupStyle>
                    <GroupStyle.Panel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel Orientation="Vertical" />
                        </ItemsPanelTemplate>
                    </GroupStyle.Panel>

                    <GroupStyle.ContainerStyle>
                        <Style TargetType="{x:Type GroupItem}">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate>
                                        <!--  Не знал, что Name передаёт тип привязки от PropertyGroupDescription  -->
                                        <Expander
                                            Padding="0"
                                            BorderThickness="0"
                                            Header="{Binding Name}"
                                            HeaderTemplateSelector="{StaticResource headerTemplates}"
                                            IsExpanded="True">
                                            <ItemsPresenter Margin="5,0,0,0" />
                                        </Expander>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </GroupStyle.ContainerStyle>
                </GroupStyle>
            </ListBox.GroupStyle>

            <ListBox.ItemTemplate>
                <!--  Тут тоже можно шаблонировать под каждый тип, но пока базового достаточно  -->
                <DataTemplate DataType="{x:Type models:BaseDevice}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <Grid.ColumnDefinitions>
                            <ColumnDefinition />
                            <ColumnDefinition Width="30" />
                        </Grid.ColumnDefinitions>

                        <TextBlock FontWeight="Bold" Text="{Binding Model, StringFormat='Модель: {0}'}" />
                        <TextBlock
                            Grid.Row="1"
                            Text="{Binding Name}"
                            TextWrapping="WrapWithOverflow" />

                        <Button
                            Grid.RowSpan="2"
                            Grid.Column="1"
                            MaxHeight="30"
                            Margin="5,0,0,0"
                            Command="{Binding DataContext.DeleteDeviceCommand, RelativeSource={RelativeSource AncestorType={x:Type ListBox}}}"
                            CommandParameter="{Binding}"
                            Content="🗑️"
                            ToolTipService.ToolTip="Удалить устройство" />
                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <Button
            Grid.Row="3"
            MaxWidth="200"
            MaxHeight="30"
            Padding="5,3"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Command="{Binding AddDeviceCommand, Mode=OneTime}"
            Content="+ Добавить устройство" />

        <TextBlock
            Grid.RowSpan="2"
            Grid.Column="2"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            FontSize="18"
            FontWeight="Bold"
            Text="Окно свойств" />

        <StackPanel
            Grid.Row="2"
            Grid.RowSpan="2"
            Grid.Column="2"
            MaxWidth="400"
            DataContext="{Binding DeviceProperties}">

            <TextBlock Text="Категория" />
            <TextBox IsEnabled="False" Text="{Binding Category, Mode=OneWay}" />

            <TextBlock Margin="0,5,0,0" Text="Модель" />
            <TextBox Text="{Binding Model, ValidatesOnNotifyDataErrors=True, ValidatesOnDataErrors=True, NotifyOnValidationError=True, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <TextBlock Margin="0,5,0,0" Text="Наименование" />
            <TextBox Text="{Binding Name, ValidatesOnNotifyDataErrors=True, ValidatesOnDataErrors=True, NotifyOnValidationError=True, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <TextBlock Margin="0,5,0,0" Text="Серийный номер" />
            <TextBox Text="{Binding SerialNumber, ValidatesOnNotifyDataErrors=True, ValidatesOnDataErrors=True, NotifyOnValidationError=True, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <TextBlock Margin="0,5,0,0" Text="Дата установки" />
            <DatePicker IsTodayHighlighted="True" SelectedDate="{Binding SetupDate, Mode=TwoWay}" />

            <TextBlock Margin="0,5,0,0" Text="Статус" />
            <ComboBox
                DisplayMemberPath="Display"
                ItemsSource="{Binding Statuses, Mode=OneTime}"
                SelectedValue="{Binding Status, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                SelectedValuePath="Status" />

            <StackPanel
                Margin="0,5,0,0"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Orientation="Horizontal">

                <StackPanel.Resources>
                    <Style TargetType="{x:Type Button}">
                        <Setter Property="Margin" Value="3,0,3,0" />
                        <Setter Property="Padding" Value="5,3" />
                        <Setter Property="MinWidth" Value="40" />
                    </Style>
                </StackPanel.Resources>

                <Button
                    x:Name="btnRestore"
                    Command="{Binding RestoreCommand, Mode=OneTime}"
                    Content="Вернуть значения"
                    IsCancel="True" />
                <Button
                    x:Name="btnSave"
                    Command="{Binding SaveCommand, Mode=OneTime}"
                    Content="Сохранить"
                    IsDefault="True" />
            </StackPanel>
        </StackPanel>
    </Grid>
</Page>
